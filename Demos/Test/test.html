<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" dir="ltr" lang="en">
<head>	
	<link rel="stylesheet" type="text/css" href="demo.css" media="screen" title="Normal" />
	<script type="text/javaScript" src="../../Clients/mootools-core.js"></script>
	<script type="text/javaScript" src="../../Clients/MooTools.js"></script>
	<script type="text/javaScript" src="../config.js"></script>
</head>
<body>
	<script type="text/javaScript">
		//Create random string used as user nickname
		function rand_chars(){
			 var keylist="abcdefghijklmnopqrstuvwxyz123456789"
			 var temp=''
			 var plength=5;
			 for (i=0;i<plength;i++){
				 temp+=keylist.charAt(Math.floor(Math.random()*keylist.length))
			}
			return temp;
		}

		// Add Session.js to APE JSF to handle multitab and page refresh

		var client = new APE.Client();

		// Connect to the APE Server
		client.load({
			identifier: 'testdemo' // Identifier of the application 
		});

		client.addEvent('load', function() {
			client.core.start();
		});
var mp;
		client.addEvent('pipeCreate', function(type, pipe, options) {
				mp = pipe;
				console.log('here');
				mp.request.send('TEST', {'test':'test'});
		});
client.addEvent('userJoin', function() {
		console.log(arguments);
});
client.addEvent('pipeCreate', function(type, pipe, args) {
		if (pipe.pipe.properties.name == 'titi') {

			pipe.addEvent('userJoin', function() {
				console.log('joined');
			});
		}

});
		client.addEvent('init', function() {
			console.log('connected to ape');
			client.core.request.cycledStack.add('SESSION', {"action":"set","values":{'test':'banzai'}});
			client.core.join('titi');
//			client.core.request.stack.add('SESSION', {"action":"set","values":{'test':'banzai'}});
//			client.core.request.stack.add('JOIN', {"channels":"toto"});
//			client.core.request.stack.add('JOIN', {"channels":"tata"});

			(function(){
//			 	client.core.request.stack.send();
			 }).delay(2500);
		});


	</script>
	</body>
</html>
